<html lang="en">

<head>
  <meta charset="utf-8">
  <title> Altizure 5.12 Visibility analysis overlap </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
</head>

<body style="margin: 0px; padding: 0px;">
  <div id="page-content"></div>
  <script type="text/javascript" src="https://beta.altizure.cn/sdk"></script>
  <!--<script type="text/javascript" src="../release/altizure-earth-apis.min.js"></script>-->
  <script>
    let sandbox = null
    let marker = null
    let camera_alt = null
    let visibilityManage = []
    let cameraMarker = []
    let timer = null
    let judge = false
    let count=0
    const point_list = [
      // [112.170031, 22.982716, 13.67],
      // [112.170005,22.982723,14.86 ],
      [112.170017, 22.982718, 13.88],
      [112.170070, 22.982745, 12.37],
      [112.170111, 22.982790, 12.13],
      [112.170182, 22.982727, 13.48],
      [112.170209, 22.982665, 11.14],
    ].map(function (lnglatalt) {
      return new altizure.LngLatAlt(lnglatalt[0], lnglatalt[1], lnglatalt[2])
    })
    let LookAtPoint = { lng: 112.170126, lat: 22.982691, alt: 11.27 }
    let LookAtPoint2 = { lng: 112.170060, lat: 22.982665, alt: 14.98 }

    let options = {
      altizureApi: {
        key: '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'
      },
      camera: {
        poseTo: {
          alt: 150,
          lat: point_list[2].lat,
          lng: point_list[2].lng,
        },
        flyTo: {
          alt: 150,
          lat: point_list[2].lat,
          lng: point_list[2].lng,
          north: 0,
          tilt: 40
        }
      },
      renderItems: {
        earth: true,
        earthUseTexture: true,
        featureInView: false,
        orbitRing: true
      }
    }
    sandbox = new altizure.Sandbox('page-content', options)

    sandbox.add('AltizureProjectMarker', { pid: '5c249bf10843bc542d9cd19f' })
      .then(projectMarker => {
        marker = projectMarker
        marker.dim()
        return marker.initialized
      })
      .then(() => {
        Visibility_analysis_overlap()
        camera_alt = sandbox.camera.pose.alt
      })
      .then(() => {
        timer = setInterval(timer_change, 1000)
        document.addEventListener('click', handler)
      })
    function handler() {
      if(count==5){
        cameraMarker[count-1].showFar=false
        count=0
      }
      cameraMarker[count].showFar = true
      if(count!=0){
      cameraMarker[count-1].showFar=false
      }
      count=count+1
      
      // if (judge == false) {
      //   cameraMarker.map((camera) => {
      //     camera.showFar = true
      //   })
      //   judge = true
      // }
      // else {
      //   cameraMarker.map((camera) => {
      //     camera.showFar = false
      //   })
      //   judge = false
      // }
    }
    function Visibility_analysis_overlap() {
      sandbox.render(marker, 'visibility')
      point_list.map((point, i) => {
        cameraMarker[i] = new altizure.CameraMarker({
          sandbox: sandbox,
          // camToEarth: mat,
          position: { "lng": point.lng, "lat": point.lat, "alt": point.alt + 1.6 },
          showFar: false,
          showNear: true,
          color: 0xff0000, // the color of the camera
          fov: 60,
        })
        cameraMarker[i].farInMeter = 40
        cameraMarker[i].nearInMeter = 0.1
        visibilityManage[i] = marker.showVisibility(cameraMarker[i])
        if (i == 3) {
          cameraMarker[i].lookAt(LookAtPoint2)
          cameraMarker[i].aspect = 0.8
          cameraMarker[i].fov = 90
          // cameraMarker[i].showFar= true
        }
        else {
          cameraMarker[i].lookAt(LookAtPoint)

        }

        visibilityManage[i].update({
          cameraMarker: cameraMarker[i]
        })
        let true_i = i + 1
        let testTag = new altizure.TextTagMarker({
          text: 'NO. ' + true_i,
          textStyle: {
            fillStyle: 'rgb(255, 255, 255)',
            font: '500 24px Arial',
            outlineWidth: 0.1,
            outlineStyle: 'rgb(0, 0, 0)'
          },
          position: point,
          sandbox: sandbox,
          scale: 0.5,
          pinLength: 30
        })
      })
    }

    function timer_change() {
      if (Math.abs(camera_alt - sandbox.camera.pose.alt) >= 10) {
        visibilityManage.map((manage, i) => {
          manage.update({
            cameraMarker: cameraMarker[i]
          })
        })
        camera_alt = sandbox.camera.pose.alt
        console.log(camera_alt)
      }
    }
  </script>
</body>

</html>