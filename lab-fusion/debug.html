<html lang="en">
  <head>
    <meta charset="utf-8">
    <title> Fusion </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  </head>
  <body>
    <div id="page-content"></div>
    <script type="text/javascript" src="../build/altizure.js"></script>
    <script>
      let options = {
        altizureApi:{
          key: '7MkQf8UggsPaadvrlKALspJWZejZAJOLHn3cnIy'
        },
        camera: {
          poseTo: {
            alt: 846.67280297181,
            lat: 22.67860532430025,
            lng: 114.33857024357965,
            north: -64.63273698329787,
            tilt: 47.24391377460331 },
          flyTo: {
            alt: 846.67280297181,
            lat: 22.67860532430025,
            lng: 114.33857024357965,
            north: -64.63273698329787,
            tilt: 47.24391377460331 },
        },
        renderItems: {
          earth: true,
          earthUseTexture: true,
          featureInView: false,
          orbitRing: true
        }
      }
      let sandbox = new altizure.Sandbox('page-content', options)

      let model = null
      let snap = null
      sandbox.add('AltizureProjectMarker', {pid: '59140cf3e3f8483d35bf8971'})
      .then((marker) => {
        console.log('marker', marker)
        model = marker

        marker.importPhotos({
          url: {
            cameraFile: '../public/assets/fusion/cp/camera/0_0_0.json',
            // photoBase: 'https://www.altizure.com/user_drive2/59140cf3e3f8483d35bf8971/'
            photoBase: '../public/assets/fusion/59140cf3e3f8483d35bf8971/'
          }
        })
        snap = model.photos.snap
      })

      //  {lng: 114.33791528127928, lat: 22.678992152138612, alt: 152.5334995052571}
      //  {lng: 114.33699889751146, lat: 22.679007510289996, alt: 151.80666306858524}
      //  {lng: 114.33702151121001, lat: 22.67818083083041, alt: 152.5651249669719}
      //  {lng: 114.3379466937555, lat: 22.678169772488175, alt: 154.58566959692158}

      // polygon 1
      let volume1 = {
        color: 0xf18100,
        opacity: 0.3,
        points: [
            [114.33791528127928, 22.678992152138612],
            [114.33699889751146, 22.679007510289996],
            [114.33702151121001, 22.67818083083041],
            [114.3379466937555, 22.678169772488175],
            [114.33791528127928, 22.678992152138612]
        ].map((lnglat) => {
          return new altizure.LngLatAlt(lnglat[0], lnglat[1], 0)
        }),
        top: 200,
        bottom: 140,
      }
      let poly1 = new altizure.PolygonMarker({
        volume: volume1,
        sandbox: sandbox,
        name: 'polygon1',
        interactable: true
      })
      poly1.on('mouseenter', function (event) {
        poly1.opacity = 0.1
      })
      poly1.on('mouseleave', function (event) {
        poly1.opacity = 0.3
      })
      poly1.on('click', function (event) {
        poly1.color = Math.random()*0xffffff
      })
      

      window.addEventListener('mouseup', () => {
        if (model) {
          let photos = model.photos
          if (photos) {
            photos.snap( {
                dist: 50,
                orient: 15, // in degree
                alpha: 0.1
              }, 2000)
          }
        }
      })

      window.addEventListener('mousedown', () => {
        if (model) {
          model.disposeCurrentDisplay()
        }
      })

      // document.addEventListener('click', handler)
      // document.addEventListener('touchstart', handler)

      function handler (event) {
        console.log(event)
        let pt = sandbox.pickOnProjects(event)

        if (!pt) {
          return
        }
        console.log('onclick point coordinate', pt)
        // alert(`longitude: ${pt.lng}(deg), latitude: ${pt.lat}(deg), altitude ${pt.alt}(m)`)

        new altizure.TagMarker({
          // img url
          imgUrl: '../public/assets/img/tag/normal/tagDemo.png',
          // icon position
          position: {
            "lng": pt.lng,
            "lat": pt.lat,
            "alt": pt.alt
          },
          // scene
          sandbox: sandbox,
          scale: 1 // icon size
        })

        let tt = new altizure.TextTagMarker({
          // text string
          text: `(${pt.lng.toPrecision(9)}, ${pt.lat.toPrecision(9)}, ${pt.alt.toPrecision(7)})`,
          // text style
          textStyle: {
            fillStyle: 'rgb(255, 255, 255)',
            font: 'normal 500 24px Arial',
            outlineWidth: 2,
            outlineStyle: 'rgb(0, 0, 0)'
          },

          // icon position
          position: {
            "lng": pt.lng,
            "lat": pt.lat,
            "alt": pt.alt
          },
          // scene
          sandbox: sandbox,
          scale: 1 // icon size
        })
      }

    </script>
  </body>
</html>